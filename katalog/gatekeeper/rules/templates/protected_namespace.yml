# Copyright (c) 2020 SIGHUP s.r.l All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

---
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8sprotectednamespace
spec:
  crd:
    spec:
      names:
        kind: K8sProtectedNamespace
        listKind: K8sProtectedNamespaceList
        plural: k8sprotectednamespace
        singular: k8sprotectednamespace
      validation:
        openAPIV3Schema:
          properties:
            namespaces:
              type: list # Default is empty list
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8sprotectednamespace

        violation[{"msg": msg}] {
          name := input.review.object.metadata.name
          labels := input.review.object.metadata.labels
          kind := input.review.object.kind
          operation :=  input.review.object.operation
          kind == "Namespace"
          operation == "DELETE"
          annotation := input.review.object.metadata.annotations["protected"]
          not annotation == "no"
          msg := sprintf("the namespace %s is protected so cannot be deleted. To unprotect the namespace add the annotation protected=no", [name])
        }
